<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kids Story Book Generator</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#eef1ff; --accent:#7dd3fc; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#070a14, #0b1020); color:var(--text); }
    header { padding:18px 16px 10px; position:sticky; top:0; backdrop-filter: blur(10px);
      background: rgba(11,16,32,.75); border-bottom:1px solid rgba(125,211,252,.15); z-index:5; }
    header h1 { margin:0; font-size:18px; }
    header p { margin:6px 0 0; color:rgba(238,241,255,.75); font-size:12.5px; line-height:1.35; }
    main { padding:14px 16px 90px; max-width: 980px; margin:0 auto; }
    .grid { display:grid; gap:12px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 360px 1fr; } }
    .card { background: rgba(18,26,51,.92); border: 1px solid rgba(125,211,252,.18); border-radius:16px;
      padding:14px; box-shadow: 0 10px 35px rgba(0,0,0,.35); }
    .card h2 { margin:0 0 10px; font-size:14px; color: rgba(238,241,255,.9); }
    label { display:block; font-size:12px; color: rgba(238,241,255,.8); margin:10px 0 6px; }
    input, textarea, select {
      width:100%; border-radius:12px; border:1px solid rgba(125,211,252,.22);
      background: rgba(7,10,20,.55); color: var(--text); padding:10px; font-size:14px; outline:none;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button {
      border:none; border-radius:12px; padding:10px 12px; font-weight:650; cursor:pointer;
      background: rgba(125,211,252,.18); color: var(--text);
      border:1px solid rgba(125,211,252,.28);
    }
    button.primary { background: rgba(125,211,252,.32); }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .status { margin-top:10px; font-size:12.5px; color: rgba(238,241,255,.8); line-height:1.35; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px;
      border:1px solid rgba(255,255,255,.15); margin-right:6px; }
    .book { display:flex; flex-direction:column; gap:12px; }
    .pageCard { border:1px solid rgba(125,211,252,.16); border-radius:16px; padding:12px; background: rgba(7,10,20,.35); }
    .pageTop { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .pageTop h3 { margin:0; font-size:13px; }
    .imgWrap { display:grid; grid-template-columns: 120px 1fr; gap:10px; align-items:start; }
    @media (max-width: 520px){ .imgWrap { grid-template-columns: 1fr; } }
    .thumb { width:100%; max-width:220px; border-radius:14px; border:1px solid rgba(125,211,252,.18);
      background: rgba(0,0,0,.15); aspect-ratio: 4/3; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .small { font-size:12px; color: rgba(238,241,255,.72); }
    .footerBar {
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(11,16,32,.9); border-top:1px solid rgba(125,211,252,.16);
      padding:10px 12px; display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    a { color: var(--accent); }
  </style>
</head>

<body>
<header>
  <h1>Kids Story Book Generator</h1>
  <p>Outline → editable pages → AI images → Export PDF. (API key hidden via Cloudflare Worker)</p>
</header>

<main class="grid">
  <section class="card">
    <h2>1) Book Settings</h2>

    <label>Pages (4–12)</label>
    <select id="pages">
      <option>4</option><option>6</option><option>8</option><option selected>10</option><option>12</option>
    </select>

    <div class="row">
      <div>
        <label>Illustration Aspect Ratio</label>
        <select id="aspect">
          <option value="1:1">1:1</option>
          <option value="4:3" selected>4:3</option>
          <option value="3:4">3:4</option>
          <option value="16:9">16:9</option>
          <option value="9:16">9:16</option>
        </select>
      </div>
      <div>
        <label>Mode</label>
        <select id="mode">
          <option value="color" selected>Colour storybook</option>
          <option value="coloring">Colouring book (line art, B/W)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>PDF Size</label>
        <select id="bookSize">
          <option value="8.5x8.5" selected>Square 8.5" × 8.5"</option>
          <option value="8x10">Portrait 8" × 10"</option>
          <option value="A4">A4</option>
        </select>
      </div>
      <div>
        <label>Author Name</label>
        <input id="author" placeholder="e.g., Coach Daniel Phua" />
      </div>
    </div>

    <h2 style="margin-top:14px;">2) Story Inputs</h2>

    <label>Main Character(s)</label>
    <input id="character" placeholder="e.g., a kind panda who becomes a doctor" />

    <label>Story Setting</label>
    <input id="setting" placeholder="e.g., a cozy bamboo town, big hospital" />

    <label>Moral / Lesson</label>
    <input id="moral" placeholder="e.g., kindness helps everyone heal" />

    <label>Style Notes (optional)</label>
    <input id="styleNotes" placeholder="e.g., cute children’s book, soft watercolor, consistent character look" />

    <label>Book Title (optional)</label>
    <input id="title" placeholder="e.g., Dr. Panda’s Big Heart" />

    <label>Extra Prompt (optional)</label>
    <textarea id="extraPrompt" placeholder="Anything else? e.g., include a friendship side character, keep language simple for ages 4–7"></textarea>

    <div class="btns">
      <button class="primary" id="btnOutline">Generate Editable Outline</button>
      <button id="btnImages" disabled>Generate Images</button>
      <button id="btnPDF" disabled>Export PDF</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="status" id="status">
      <span class="pill">Info</span> First generate outline, edit text/prompts, then generate images, then export PDF.
    </div>

    <div class="small" style="margin-top:10px;">
      <b>Consistency tip:</b> This app generates a <i>Character Anchor</i> and repeats it in every image prompt.
    </div>
  </section>

  <section class="card">
    <h2>3) Your Book (editable)</h2>
    <div id="book" class="book"></div>
  </section>
</main>

<div class="footerBar">
  <div class="small">Download outline JSON for backup:</div>
  <a href="#" id="downloadJson">Download Outline JSON</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/**
 * Worker URL already inserted for you ✅
 */
const WORKER_BASE_URL = "https://kids-storybook-gemini-proxy.danielphua85.workers.dev";

const el = (id) => document.getElementById(id);
const statusEl = el("status");
const bookEl = el("book");

let bookState = null;

function setStatus(type, msg){
  statusEl.innerHTML = `<span class="pill">${type}</span> ${msg}`;
}

function getPdfSize(){
  const v = el("bookSize").value;
  if (v === "8.5x8.5") return { w: 8.5*72, h: 8.5*72 };
  if (v === "8x10")    return { w: 8*72, h: 10*72 };
  return { w: 595, h: 842 };
}

function safeJsonParse(text){
  const start = text.indexOf("{");
  const end = text.lastIndexOf("}");
  if (start >= 0 && end > start) return JSON.parse(text.slice(start, end+1));
  return JSON.parse(text);
}

async function proxyPost(path, body){
  const res = await fetch(`${WORKER_BASE_URL}${path}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(`Proxy error (${res.status}): ${txt}`);
  return JSON.parse(txt);
}

async function proxyGenerateText(prompt){
  const body = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { temperature: 0.7, maxOutputTokens: 4096 }
  };
  const data = await proxyPost("/text", body);
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const text = parts.map(p => p.text).filter(Boolean).join("\n");
  if (!text) throw new Error("No text returned from Gemini.");
  return text;
}

async function proxyGenerateImage(prompt, aspectRatio){
  const body = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      responseModalities: ["Image"],
      imageConfig: { aspectRatio }
    }
  };
  const data = await proxyPost("/image", body);
  const parts = data?.candidates?.[0]?.content?.parts || [];
  const imgPart = parts.find(p => p.inlineData && p.inlineData.data);
  if (!imgPart) throw new Error("No image returned from Gemini image model.");
  const b64 = imgPart.inlineData.data;
  const mime = imgPart.inlineData.mimeType || "image/png";
  return `data:${mime};base64,${b64}`;
}

function buildInputs(){
  return {
    pages: Number(el("pages").value),
    character: el("character").value.trim(),
    setting: el("setting").value.trim(),
    moral: el("moral").value.trim(),
    styleNotes: el("styleNotes").value.trim(),
    author: el("author").value.trim(),
    title: el("title").value.trim(),
    extraPrompt: el("extraPrompt").value.trim(),
    mode: el("mode").value
  };
}

function buildOutlinePrompt(i){
  const artMode = i.mode === "coloring"
    ? "Colouring book line art: black & white, clean outlines, no shading, no grey."
    : "Colour storybook: soft watercolor / children’s book illustration, gentle palette.";

  return `
You are a professional children's picture book author + editor.
Create a complete picture-book plan with a COVER and ${i.pages} PAGES.
Return ONLY valid JSON. No markdown.

Rules:
- Simple English for ages 4–8.
- Each page text: 1–2 short sentences (max ~25 words).
- Keep ONE main character design consistent across all pages.
- Include the moral naturally (not preachy).
- No scary/unsafe content.

Inputs:
- Main character(s): ${i.character}
- Setting: ${i.setting}
- Moral: ${i.moral}
- Style notes: ${i.styleNotes || "none"}
- Author: ${i.author || "Unknown"}
- Optional title: ${i.title || "Generate a great title"}
- Mode: ${artMode}
- Extra: ${i.extraPrompt || "none"}

You MUST create a "characterAnchor" that acts like a character bible:
Include species, colors, outfit + 1 signature item, and strict rules "do not change".

JSON schema:
{
  "meta": { "author": "string", "targetAge": "4-8", "mode": "color|coloring" },
  "characterAnchor": "string",
  "cover": { "title": "string", "subtitle": "string(optional)", "imagePrompt": "string" },
  "pages": [
    { "sceneTitle":"string", "pageText":"string", "imagePrompt":"string" }
  ]
}
`.trim();
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }

function enableButtons(){
  el("btnImages").disabled = !bookState;
  const hasAnyImage = bookState && (bookState.cover.imageDataUrl || bookState.pages.some(p => p.imageDataUrl));
  el("btnPDF").disabled = !bookState || !hasAnyImage;
}

function renderBook(){
  bookEl.innerHTML = "";
  if (!bookState){
    bookEl.innerHTML = `<div class="small">No book yet. Generate an outline to begin.</div>`;
    return;
  }

  const cover = document.createElement("div");
  cover.className = "pageCard";
  cover.innerHTML = `
    <div class="pageTop"><h3>Cover</h3><div class="small">Character Anchor enforces consistency.</div></div>

    <label>Title</label>
    <input data-cover="title" value="${escapeAttr(bookState.cover.title || "")}" />

    <label>Subtitle (optional)</label>
    <input data-cover="subtitle" value="${escapeAttr(bookState.cover.subtitle || "")}" />

    <label>Author</label>
    <input data-meta="author" value="${escapeAttr(bookState.meta.author || "")}" />

    <label>Character Anchor (auto-generated — edit if character changes)</label>
    <textarea data-meta="anchor">${escapeHtml(bookState.characterAnchor || "")}</textarea>

    <label>Cover Image Prompt (editable)</label>
    <textarea data-cover="imgPrompt">${escapeHtml(bookState.cover.imagePrompt || "")}</textarea>

    <div class="imgWrap" style="margin-top:10px;">
      <div class="thumb">${bookState.cover.imageDataUrl ? `<img src="${bookState.cover.imageDataUrl}" alt="Cover">` : `<span class="small">No cover image yet</span>`}</div>
      <div class="small">Edit prompts → regenerate images anytime.</div>
    </div>
  `;
  cover.addEventListener("input", (e) => {
    const t = e.target;
    if (t.dataset.cover === "title") bookState.cover.title = t.value;
    if (t.dataset.cover === "subtitle") bookState.cover.subtitle = t.value;
    if (t.dataset.cover === "imgPrompt") bookState.cover.imagePrompt = t.value;
    if (t.dataset.meta === "author") bookState.meta.author = t.value;
    if (t.dataset.meta === "anchor") bookState.characterAnchor = t.value;
    enableButtons();
  });
  bookEl.appendChild(cover);

  bookState.pages.forEach((p, idx) => {
    const c = document.createElement("div");
    c.className = "pageCard";
    c.innerHTML = `
      <div class="pageTop"><h3>Page ${idx+1}</h3><div class="small">${escapeHtml(p.sceneTitle || "")}</div></div>

      <label>Scene Title</label>
      <input data-k="sceneTitle" data-i="${idx}" value="${escapeAttr(p.sceneTitle || "")}" />

      <label>Page Text</label>
      <textarea data-k="pageText" data-i="${idx}">${escapeHtml(p.pageText || "")}</textarea>

      <label>Illustration Prompt</label>
      <textarea data-k="imagePrompt" data-i="${idx}">${escapeHtml(p.imagePrompt || "")}</textarea>

      <div class="imgWrap" style="margin-top:10px;">
        <div class="thumb">${p.imageDataUrl ? `<img src="${p.imageDataUrl}" alt="Page ${idx+1}">` : `<span class="small">No image yet</span>`}</div>
        <div class="small">If character drifts: strengthen Character Anchor (colors/outfit/signature item).</div>
      </div>
    `;
    c.addEventListener("input", (e) => {
      const t = e.target;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (Number.isFinite(i) && k) bookState.pages[i][k] = t.value;
      enableButtons();
    });
    bookEl.appendChild(c);
  });

  enableButtons();
}

async function onGenerateOutline(){
  try{
    const inputs = buildInputs();
    if (!inputs.character || !inputs.setting || !inputs.moral) throw new Error("Fill: Character(s), Setting, Moral.");

    setStatus("Info", "Generating outline…");
    el("btnOutline").disabled = true;

    const raw = await proxyGenerateText(buildOutlinePrompt(inputs));
    const outline = safeJsonParse(raw);
    if (!outline.pages || !outline.pages.length) throw new Error("Missing pages in outline.");

    bookState = {
      meta: { author: outline.meta?.author || inputs.author || "", targetAge: "4-8", mode: inputs.mode },
      characterAnchor: outline.characterAnchor || "",
      cover: {
        title: outline.cover?.title || inputs.title || "Untitled Story",
        subtitle: outline.cover?.subtitle || "",
        imagePrompt: outline.cover?.imagePrompt || "A beautiful children’s book cover illustration.",
        imageDataUrl: null
      },
      pages: outline.pages.slice(0, inputs.pages).map(p => ({
        sceneTitle: p.sceneTitle || "",
        pageText: p.pageText || "",
        imagePrompt: p.imagePrompt || "",
        imageDataUrl: null
      }))
    };

    renderBook();
    setStatus("OK", "Outline ready. Edit → Generate Images.");
  }catch(err){
    console.error(err);
    setStatus("Error", err.message || String(err));
  }finally{
    el("btnOutline").disabled = false;
  }
}

async function onGenerateImages(){
  try{
    if (!bookState) throw new Error("Generate outline first.");
    const aspect = el("aspect").value;
    const mode = el("mode").value;

    setStatus("Info", "Generating images…");
    el("btnImages").disabled = true;
    el("btnOutline").disabled = true;

    const styleSafety = mode === "coloring"
      ? "Style: black & white line art, clean outlines, no shading."
      : "Style: children’s book illustration, cohesive character design, gentle palette.";

    const anchor = (bookState.characterAnchor || "").trim();
    const anchorBlock = anchor ? `Character Anchor (MUST FOLLOW EXACTLY): ${anchor}` : "";

    const coverPrompt = `${anchorBlock}
${bookState.cover.imagePrompt}
${styleSafety}
Rules: keep same character design/outfit/colors. No brands. No copyrighted characters. Kid-safe.`;
    bookState.cover.imageDataUrl = await proxyGenerateImage(coverPrompt, aspect);
    renderBook();

    for (let i=0; i<bookState.pages.length; i++){
      const p = bookState.pages[i];
      const pagePrompt = `${anchorBlock}
Scene: ${p.sceneTitle}
Illustration details: ${p.imagePrompt}
${styleSafety}
Rules: keep same character design/outfit/colors/signature item. No brands. No copyrighted characters. Kid-safe.`;
      p.imageDataUrl = await proxyGenerateImage(pagePrompt, aspect);
      renderBook();
      setStatus("Info", `Generated image ${i+1}/${bookState.pages.length}…`);
    }

    setStatus("OK", "All images done. Export PDF now.");
  }catch(err){
    console.error(err);
    setStatus("Error", err.message || String(err));
  }finally{
    el("btnImages").disabled = false;
    el("btnOutline").disabled = false;
    enableButtons();
  }
}

async function onExportPDF(){
  try{
    if (!bookState) throw new Error("No book to export.");
    const { jsPDF } = window.jspdf;

    setStatus("Info", "Building PDF…");
    el("btnPDF").disabled = true;

    const size = getPdfSize();
    const doc = new jsPDF({ unit: "pt", format: [size.w, size.h] });

    const margin = 28;
    const imgH = size.h * 0.58;
    const imgW = size.w - margin*2;
    const textY = margin + imgH + 18;

    function addPage(imageDataUrl, title, body, footer){
      doc.setFillColor(11,16,32);
      doc.rect(0,0,size.w,size.h,"F");

      if (imageDataUrl){
        doc.addImage(imageDataUrl, "PNG", margin, margin, imgW, imgH, undefined, "FAST");
      } else {
        doc.setDrawColor(160);
        doc.rect(margin, margin, imgW, imgH);
      }

      doc.setTextColor(238,241,255);
      doc.setFont("helvetica","bold");
      doc.setFontSize(18);
      doc.text(title || "", margin, textY);

      doc.setFont("helvetica","normal");
      doc.setFontSize(12.5);
      const lines = doc.splitTextToSize(body || "", imgW);
      doc.text(lines, margin, textY + 18);

      doc.setFontSize(10.5);
      doc.setTextColor(200,205,230);
      doc.text(footer || "", margin, size.h - 18);
    }

    const coverTitle = bookState.cover.title || "Untitled Story";
    const coverSub = bookState.cover.subtitle ? `\n${bookState.cover.subtitle}` : "";
    addPage(bookState.cover.imageDataUrl, coverTitle, coverSub, `By ${bookState.meta.author || "Unknown"}`);

    for (let i=0; i<bookState.pages.length; i++){
      doc.addPage([size.w, size.h], "pt");
      const p = bookState.pages[i];
      addPage(p.imageDataUrl, p.sceneTitle, p.pageText, `${coverTitle} • Page ${i+1}`);
    }

    const safeName = (coverTitle || "storybook").replace(/[^\w\-]+/g,"_").slice(0,60);
    doc.save(`${safeName}.pdf`);

    setStatus("OK", "PDF saved to your phone (Files/Downloads).");
  }catch(err){
    console.error(err);
    setStatus("Error", err.message || String(err));
  }finally{
    el("btnPDF").disabled = false;
    enableButtons();
  }
}

function onReset(){
  bookState = null;
  renderBook();
  enableButtons();
  setStatus("Info", "Reset done.");
}

function downloadOutlineJson(){
  if (!bookState) return;
  const blob = new Blob([JSON.stringify(bookState, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${(bookState.cover.title||"outline").replace(/[^\w\-]+/g,"_").slice(0,60)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

el("btnOutline").addEventListener("click", onGenerateOutline);
el("btnImages").addEventListener("click", onGenerateImages);
el("btnPDF").addEventListener("click", onExportPDF);
el("btnReset").addEventListener("click", onReset);
el("downloadJson").addEventListener("click", (e)=>{ e.preventDefault(); downloadOutlineJson(); });

renderBook();
enableButtons();
</script>
</body>
</html>
